---
name: K3s Argo-Diff Test

on:
  workflow_run:
    workflows: ["Docker build"]
    types:
      - completed
  pull_request:
    branches: ["main"]
    paths:
      - '.github/workflows/k3s.yml'
      - 'test/**'

permissions:
  contents: read
  pull-requests: write

env:
  ARGOCD_OPTS: '--port-forward --port-forward-namespace argocd --insecure --plaintext'

jobs:
  k3s:
    # Only run on pull_request events or successful workflow_run from dockerbuild in a pull request
    if: ${{ github.event_name == 'pull_request' || (github.event_name == 'workflow_run' && github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.conclusion == 'success') }}
    strategy:
      fail-fast: false
      matrix:
        k8s: [v1.34]  # v1.33, v1.32, v1.31, v1.30]
    name: K8s ${{ matrix.k8s }}
    runs-on: ubuntu-latest
    steps:
      - name: Git Checkout
        id: git_checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Determine argo-diff image tag and PR refs
        id: pr_info
        env:
          PR_DATA: ${{ toJSON(github.event.workflow_run.pull_requests) }}
        run: |
          # Default values
          IMAGE_TAG="main"
          HEAD_REF="${{ github.head_ref }}"
          BASE_REF="${{ github.base_ref }}"
          PR_REF="${{ github.ref }}"

          if [[ "${{ github.event_name }}" == "workflow_run" && "${{ github.event.workflow_run.event }}" == "pull_request" ]]; then
            # Triggered by dockerbuild.yml workflow on a PR - extract PR context from workflow_run
            PR_NUMBER=$(echo "$PR_DATA" | jq -r '.[0].number')
            HEAD_REF=$(echo "$PR_DATA" | jq -r '.[0].head.ref')
            BASE_REF=$(echo "$PR_DATA" | jq -r '.[0].base.ref')
            if [[ -n "$PR_NUMBER" && "$PR_NUMBER" != "null" ]]; then
              IMAGE_TAG="pr-${PR_NUMBER}"
              PR_REF="refs/pull/${PR_NUMBER}/merge"
            fi
          fi

          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "HEAD_REF=${HEAD_REF}" >> $GITHUB_OUTPUT
          echo "BASE_REF=${BASE_REF}" >> $GITHUB_OUTPUT
          echo "PR_REF=${PR_REF}" >> $GITHUB_OUTPUT
          echo "Using argo-diff image tag: ${IMAGE_TAG}"
          echo "Head ref (source branch): ${HEAD_REF}"
          echo "Base ref (target branch): ${BASE_REF}"
          echo "PR ref: ${PR_REF}"

      - name: K3d/K3s Setup
        id: k3s_setup
        timeout-minutes: 2
        uses: nolar/setup-k3d-k3s@v1
        with:
          version: ${{ matrix.k8s }}
          k3d-args: -p 8080:443@loadbalancer

      - name: K3s Cluster verification
        id: k3s_verify
        timeout-minutes: 1
        run: kubectl version

      - name: Install ArgoCD via HelmChart CRD
        id: argocd_install
        timeout-minutes: 1
        run: |
          kubectl create namespace argocd
          kubectl apply -n kube-system -f test/argocd-helmchart.yaml --server-side=true

      - name: Wait for HelmChart to deploy
        id: argocd_helm_wait
        timeout-minutes: 2
        run: |
          echo "Waiting for HelmChart to be processed..."
          sleep 2
          job_name=$(kubectl -n kube-system get helmchart argocd -o jsonpath='{.status.jobName}')
          test -n "$job_name" || exit 1
          while sleep 1 ; do
            kubectl -n kube-system wait --for=condition=complete job/$job_name --timeout=1s && exit 0 || true
            kubectl -n kube-system wait --for=condition=failed job/$job_name --timeout=1s && exit 1 || true
          done

      - name: Wait for ArgoCD pods to be ready
        id: argocd_server_wait
        timeout-minutes: 3
        run: |
          echo "Waiting for ArgoCD pods to launch..."
          while [[ -z "$(kubectl -n argocd get pods -l app.kubernetes.io/name=argocd-server --no-headers=true)" ]]; do
            sleep 1
          done
          echo "Waiting for argocd-server pods to be ready ..."
          kubectl -n argocd wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server --timeout=180s

      - name: Debug pods if installation fails
        id: argocd_pod_debug
        timeout-minutes: 1
        if: failure()
        run: |
          kubectl -n argocd get pods -o yaml

      - name: Create ArgoCD test applications
        timeout-minutes: 1
        id: argocd_app_install
        run: |
          kubectl -n argocd apply -k test/argocd-applications/ --server-side=true
          kubectl -n argocd apply -f test/argocd-meta.yaml --server-side=true

      - name: Install ArgoCD CLI
        id: argocd_cli_install
        timeout-minutes: 2
        run: |
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x /tmp/argocd
          sudo mv /tmp/argocd /usr/local/bin/argocd
          argocd version --client

      - name: Sync Application and wait for ready
        id: argocd_app_sync
        timeout-minutes: 4
        run: |
          echo "--- App List ---"
          argocd app list
          echo "--- Wait - meta ---"
          argocd app wait meta
          echo "--- Wait - basic-deployment ---"
          argocd app wait basic-deployment
          echo "--- Wait - helm-deployment ---"
          argocd app wait helm-deployment
          #echo "--- Meta ---"
          #argocd app get meta -o tree
          #echo "--- Basic-Deployment ---"
          #argocd app get basic-deployment -o tree
          #echo "--- Helm-Deployment ---"
          #argocd app get helm-deployment -o tree
          echo
          echo "--- App List ---"
          argocd app list

      - name: Run argo-diff as a standalone pod
        id: argo_diff
        timeout-minutes: 2
        run: |
          pod_name=argo-diff-$(date +%s)
          cat <<EOF | kubectl -n argocd apply -f -
          apiVersion: v1
          kind: Pod
          metadata:
            name: $pod_name
          spec:
            restartPolicy: Never
            containers:
              - name: argo-diff
                command:
                  - /app/argo-diff
                image: ghcr.io/vince-riv/argo-diff@sha256:030826af5aee7297b9cb0246b49fe0866719f2e613fad5f4436eb057417cea05:${{ steps.pr_info.outputs.IMAGE_TAG }}  # renovate: ignore
                env:
                  - name: ARGO_DIFF_COMMENT_PREAMBLE
                    value: |
                      ## Argo-Diff - Ephemeral Environment Test
                      This argo-diff should have the same output every run
                  - name: ARGO_DIFF_CONTEXT_STR
                    value: ephemeral-environment-test
                  - name: ARGO_DIFF_SKIP_REF_CHECK
                    value: "true"
                  - name: ARGOCD_AUTH_TOKEN
                    value: dummy_value
                  - name: ARGOCD_SERVER_ADDR
                    value: argocd-server.argocd.svc.cluster.local:80
                  - name: ARGOCD_SERVER_INSECURE
                    value: "true"
                  - name: ARGOCD_SERVER_PLAINTEXT
                    value: "true"
                  - name: GITHUB_ACTIONS
                    value: "true"
                  - name: GITHUB_TOKEN
                    value: ${{ secrets.GITHUB_TOKEN }}
                  - name: GITHUB_SHA
                    value: ${{ github.event.workflow_run.head_sha || github.sha }}
                  - name: GITHUB_REF
                    value: ${{ steps.pr_info.outputs.PR_REF }}
                  - name: GITHUB_EVENT_NAME
                    value: "pull_request"
                  - name: GITHUB_HEAD_REF
                    value: ${{ steps.pr_info.outputs.HEAD_REF }}
                  - name: GITHUB_BASE_REF
                    value: "k3s-test"
                  - name: GITHUB_REPOSITORY
                    value: ${{ github.repository }}
                  - name: REPO_DEFAULT_REF
                    value: "k3s-test"
                  - name: LOG_LEVEL
                    value: "debug"
          EOF
          kubectl -n argocd wait --for=condition=ready pod/$pod_name --timeout=60s
          kubectl -n argocd logs -f $pod_name --pod-running-timeout=60s
