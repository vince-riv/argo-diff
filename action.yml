---

description: 'Preview k8s manifest changes using argocd diff'
inputs:
  argocd_auth_token:
    description: 'Bearer token for ArgoCD (value passed to --auth-token)'
    required: true
  argocd_grpc_web:
    description: 'Set --grpc-web flag for argocd cli (true/false)'
    required: false
    default: 'false'
  argocd_grpc_web_root_path:
    description: 'Value for --grpc-web-root-path for argocd cli'
    required: false
    default: ''
  argocd_server:
    description: 'ArgoCD server name (value passed to --server)'
    required: true
  argocd_server_insecure:
    description: 'Set --insecure flag for argocd cli (true/false)'
    required: false
    default: 'false'
  argocd_server_plaintext:
    description: 'Set --plaintext flag for argocd cli (true/false)'
    required: false
    default: 'false'
  argocd_ui_base_url:
    description: 'Base URL of ArgoCD UI (usually server name prefixed with https://)'
    required: false
    default: ''
  #argocd_version:
  #  description: 'Version of argocd cli to use'
  #  required: false
  #  default: 'v2.13.2'
  argocd_opts:
    description: 'Additional flags to pass to argocd cli (eg: --timeout 30s). Populates ARGOCD_OPTS'
    required: false
    default: ''
  comment_line_max_chars:
    description: 'Any individual line in Pull Request comments by argo-diff longer than this are truncated.'
    required: false
    default: ''
  comment_preamble:
    description: 'String/markdown prefixed to comments. Keep to 150 chars or less in length'
    required: false
    default: ''
  context_str:
    description: 'Unique identifier of argo-diff instance. Use when deploying multiple instances (eg: one per cluster). Recommended to be a brief cluster nickname'
    required: false
    default: ''
  github_token:
    description: 'Bearer token for github API calls (usually secrets.GITHUB_TOKEN)'
    required: true
  log_level:
    description: 'Log level of argo-diff'
    required: false
    default: info
  repo_default_ref:
    decription: 'Default branch of repository (eg: "main"); only needed when `HEAD` is specified as target revision in ArgoCD application source'
    required: false
    default: ''

runs:
  using: 'docker'
  image: 'Dockerfile.actions'
  env:
    ARGO_DIFF_COMMENT_PREAMBLE: ${{ inputs.comment_preamble }}
    ARGO_DIFF_CONTEXT_STR: ${{ inputs.context_str }}
    ARGOCD_AUTH_TOKEN: ${{ inputs.argocd_auth_token }}
    ARGOCD_GRPC_WEB: ${{ inputs.argocd_grpc_web }}
    ARGOCD_GRPC_WEB_ROOT_PATH: ${{ inputs.argocd_grpc_web_root_path }}
    ARGOCD_SERVER_ADDR: ${{ inputs.argocd_server }}
    ARGOCD_SERVER_INSECURE: ${{ inputs.argocd_server_insecure }}
    ARGOCD_SERVER_PLAINTEXT: ${{ inputs.argocd_server_plaintext }}
    ARGOCD_UI_BASE_URL: ${{ inputs.argocd_ui_base_url }}
    ARGOCD_OPTS: ${{ inputs.argocd_opts }}
    #ARGOCD_VERSION: ${{ inputs.argocd_version }}
    COMMENT_LINE_MAX_CHARS: ${{ inputs.comment_line_max_chars }}
    GITHUB_ACTIONS: "true"
    GITHUB_TOKEN: ${{ inputs.github_token }}
    LOG_LEVEL: ${{ inputs.log_level }}
    REPO_DEFAULT_REF: ${{ inputs.repo_default_ref }}
